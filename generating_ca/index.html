<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Jonathan Hanson">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Generating a Certificate Authority - Certificate Authority Guide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Generating a Certificate Authority";
    var mkdocs_page_input_path = "generating_ca.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Certificate Authority Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../details_and_setup/">Operational Overview and Setup</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Generating a Certificate Authority</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#a-note-on-the-openssl-config-files">A Note on the OpenSSL Config Files</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#generating-a-root-ca-certificate">Generating a Root CA Certificate</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#generate-a-new-key-for-the-ca-root-certificate">Generate a new Key for the CA Root Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#generate-a-certificate-signing-request-for-the-ca-root-certificate">Generate a Certificate Signing Request for the CA Root Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#self-sign-the-root-certificate">Self-Sign the Root Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#verifying-the-root-certificate">Verifying the Root Certificate</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#generating-an-intermediate-ca-certificate">Generating an Intermediate CA Certificate</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#generate-a-new-key-for-the-intermediate-certificate">Generate a New Key for the Intermediate Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#generate-a-certificate-signing-request-for-the-intermediate-certificate">Generate a Certificate Signing Request for the Intermediate Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sign-the-intermediate-certificate-with-the-ca-certificate">Sign the Intermediate Certificate with the CA Certificate</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#verifying-the-intermediate-certificate">Verifying the Intermediate Certificate</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#creating-a-chain-file">Creating a Chain File</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#safe-storage">Safe Storage</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../distribution/">Root Certificate Distribution</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../service_certificates/">Service Certificates</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../revocation_certificates/">Revoking Certificates</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../references/">References</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Certificate Authority Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Generating a Certificate Authority</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/triplepoint/certificate-authority-guide/blob/master/mkdocs/docs/generating_ca.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="building-a-certificate-authority">Building a Certificate Authority</h1>
<h2 id="a-note-on-the-openssl-config-files">A Note on the OpenSSL Config Files</h2>
<p>In our skeleton CA file structure, we've provided a copy of the openssl config file in both the <code>/root/ca</code> and <code>/root/ca/intermediate</code> directory.  These files are identical, but they're duplicated to ensure that the intermediate CA archive has its own copy if it's ever used on its own (for example, when signing a service certificate).  If for any reason you modify one of these files, be sure to similarly modify the other one.</p>
<p>We'll be careful below to explicitly set the openssl <code>-config</code> and <code>-name</code> flags for each scenario, but just be aware these two files are (or at least should be) identical.</p>
<h2 id="generating-a-root-ca-certificate">Generating a Root CA Certificate</h2>
<p>The Certificate Authority's core documents are its root certificate and the associated private key.  This is the certificate which all clients will directly trust, and it's the root of the chain of trust that ultimately extends down to the individual service certificates.</p>
<p>You'll (hopefully) only need to generate this root certificate and its key once.  We'll set the expiration for ~25 years (9130 days), and as long as the certificate isn't compromised and you don't make any mistakes, you can rely on it to function for that long.</p>
<h3 id="generate-a-new-key-for-the-ca-root-certificate">Generate a new Key for the CA Root Certificate</h3>
<p>First, we need to generate a new RSA key for the CA certificate.  The key will be encrypted with a passphrase, which you'll be prompted to supply.  You'll want to use a real non-empty password for this key and store it in a safe place.</p>
<pre><code class="language-bash">openssl genrsa \
    -aes256 \
    -out /root/ca/private/ca.key.pem \
    4096 &amp;&amp; \
chmod 400 /root/ca/private/ca.key.pem
</code></pre>
<p>This generates the new CA key at <code>/root/ca/private/ca.key.pem</code>.</p>
<h3 id="generate-a-certificate-signing-request-for-the-ca-root-certificate">Generate a Certificate Signing Request for the CA Root Certificate</h3>
<p>Next, we need to generate a Certificate Signing Request (CSR) which will define the details of the CA certificate, and which will be used to self-sign the new certificate.</p>
<p>When you are prompted for the CA Certificate Distinguished Name details, take care to get them right.  You won't want to regenerate the certificate after it's been distributed.</p>
<pre><code class="language-bash">openssl req \
    -config /root/ca/ca_openssl.cnf \
    -key /root/ca/private/ca.key.pem \
    -new \
    -sha256 \
    -out /root/ca/ca.req.pem
</code></pre>
<p>This generates the new CSR for the root certificate at <code>/root/ca/ca.req.pem</code>.</p>
<h3 id="self-sign-the-root-certificate">Self-Sign the Root Certificate</h3>
<p>Now that we have the key and a signing request, we can act on the request to self-sign the root certificate:</p>
<pre><code class="language-bash">openssl ca \
    -config /root/ca/ca_openssl.cnf \
    -name CA_root \
    -in /root/ca/ca.req.pem \
    -create_serial \
    -out /root/ca/certs/ca.cert.pem \
    -days 9130 \
    -keyfile /root/ca/private/ca.key.pem \
    -selfsign \
    -extensions v3_ca
</code></pre>
<p>This generates the new CA root certificate at <code>/root/ca/certs/ca.cert.pem</code>.  When you are prompted about "committing" say <code>y</code>; this is about starting a database of certificates signed by this authority.</p>
<h3 id="verifying-the-root-certificate">Verifying the Root Certificate</h3>
<p>Now that the root CA certificate and key are generated, you can verify them with:</p>
<pre><code class="language-bash">openssl x509 -noout -text -in /root/ca/certs/ca.cert.pem
</code></pre>
<p>TODO - what are we looking at?</p>
<h2 id="generating-an-intermediate-ca-certificate">Generating an Intermediate CA Certificate</h2>
<h3 id="generate-a-new-key-for-the-intermediate-certificate">Generate a New Key for the Intermediate Certificate</h3>
<p>Similar to what we did for the CA root certificate above, we need to generate a signing key for the CA intermediate certificate. Once again, you'll need to use a non-empty secure password and store it in a secure place:</p>
<pre><code class="language-bash">openssl genrsa \
    -aes256 \
    -out /root/ca/intermediate/private/intermediate.key.pem \
    4096 &amp;&amp; \
chmod 400 /root/ca/intermediate/private/intermediate.key.pem
</code></pre>
<p>This generates the new intermediate certificate key at: <code>/root/ca/intermediate/private/intermediate.key.pem</code>.</p>
<h3 id="generate-a-certificate-signing-request-for-the-intermediate-certificate">Generate a Certificate Signing Request for the Intermediate Certificate</h3>
<p>This document represents a request to the root CA to generate the signed intermediate certificate.</p>
<p>Note that the <code>Country Name</code>, <code>State or Province Name</code>, and <code>Organization Name</code> all have to match the values of the root CA certificate.</p>
<p>Also note that the Common Name used in this CSR <em>must</em> be distinct from the root CA certificate's Common Name, used above.</p>
<pre><code class="language-bash">openssl req \
    -config /root/ca/intermediate/int_openssl.cnf \
    -key /root/ca/intermediate/private/intermediate.key.pem \
    -new \
    -sha256 \
    -out /root/ca/intermediate/csr/intermediate.csr.pem
</code></pre>
<h3 id="sign-the-intermediate-certificate-with-the-ca-certificate">Sign the Intermediate Certificate with the CA Certificate</h3>
<p>Now we can sign the intermediate certificate with the root certificate and the root certificate's key:</p>
<pre><code class="language-bash">openssl ca \
    -config /root/ca/ca_openssl.cnf \
    -in /root/ca/intermediate/csr/intermediate.csr.pem \
    -notext \
    -out /root/ca/intermediate/certs/intermediate.cert.pem \
    -days 3650 \
    -md sha256 \
    -extensions v3_intermediate_ca &amp;&amp; \
chmod 444 /root/ca/intermediate/certs/intermediate.cert.pem
</code></pre>
<p>Answer <code>y</code> to any prompts about "commiting", this is about the database of signed certificates that OpenSSL is keeping for us (see below).
This generates the new Intermediate certificate at: <code>/root/ca/intermediate/certs/intermediate.cert.pem</code>.</p>
<p>Note here that we're giving the intermediate certificate a 10 year (3650 day) lifetime.</p>
<h3 id="verifying-the-intermediate-certificate">Verifying the Intermediate Certificate</h3>
<p>Once generated, you can verify the certificate's values with:</p>
<pre><code class="language-bash">openssl x509 \
    -noout \
    -text \
    -in /root/ca/intermediate/certs/intermediate.cert.pem
</code></pre>
<p>And you can verify the intermediate certificate's chain of trust against the CA certificate is valid with:</p>
<pre><code class="language-bash">openssl verify \
    -CAfile /root/ca/certs/ca.cert.pem \
    /root/ca/intermediate/certs/intermediate.cert.pem
</code></pre>
<h2 id="creating-a-chain-file">Creating a Chain File</h2>
<p>It's often convenient to have a combined "chain file" for a given service certificate, to represent in one place the complete chain of trust back to a trusted root certificate.  Many SSL/TLS configurations expect to have these files.</p>
<p>These chain files are simply the concatenated set of all the certificates in the chain of trust which lead back to the trusted CA root certificate:</p>
<pre><code class="language-bash">cat /root/ca/intermediate/certs/intermediate.cert.pem \
    /root/ca/certs/ca.cert.pem &gt; \
    /root/ca/intermediate/certs/ca-chain.cert.pem &amp;&amp; \
chmod 444 /root/ca/intermediate/certs/ca-chain.cert.pem
</code></pre>
<p>These are all of the CA's public certificates, so it's safe to distribute this <code>/root/ca/intermediate/certs/ca-chain.cert.pem</code> file to the services with the service certificates.</p>
<h2 id="safe-storage">Safe Storage</h2>
<p>The above work has generated several files which so far only exist on this Docker container, and which now need to be preserved:</p>
<ul>
<li>The CA root certificate and its associated key file</li>
<li>The CA intermediate certificate and its associated key file</li>
<li>The chain file combining both certificates</li>
<li>A set of <code>index.txt*</code> and <code>serial*</code> files, one for each of the two CA certificates, which track what certificates have been signed with which CA certificates</li>
<li>The <code>*openssl.cnf</code> files, one for each CA certificate, which configured OpenSSL during the various operations</li>
</ul>
<p>While not all of these files are confidential information, they should all nonetheless be packaged together and prepared for storage.  This ensures that over the years, you can reliably rebuild this working environment to perform certificate-related tasks.</p>
<p>We'll package the entire working set up into one archive at <code>/root/ca_authority.tar.gz</code>.  This file contains everything needed to operate the CA, and therefore should be  stored in a seldom-accessed, higher-security location.</p>
<p>We'll also package just the intermediate authority's files into a separate archive at <code>/root/intermediate_authority.tar.gz</code>.  Of the two archives, this is the file we'll use the most, since it's all that's necessary for managing service SSL/TLS certificates.  It can be stored in the more-convenient, less-secure site.</p>
<p>Remember to store both keys' passwords somewhere safe as well.</p>
<p>We can create the archives like this:</p>
<pre><code class="language-bash">tar -czvf /root/ca_authority.tar.gz -C /root/ca/ .
cp /root/ca_authority.tar.gz /root/ca_persist

tar -czvf /root/intermediate_authority.tar.gz -C /root/ca/intermediate/ .
cp /root/intermediate_authority.tar.gz /root/ca_persist
</code></pre>
<p>Because this "export" behavior is critical, the above shell commands are also provided on the Docker image as a script named <a href="https://github.com/triplepoint/certificate-authority-guide/blob/master/src/scripts/archive_ca"><code>archive_ca</code></a>.  You can call this command at any time to archive the working set back to the persistent directory on the Docker host:</p>
<pre><code class="language-bash">archive_ca
</code></pre>
<p>As a final note: as the intermediate archive is used, it will accrue records in its signed-certificates database and Certificate Revocation List which aren't present in the root authority archive.  Periodically, the <code>intermediate/</code> directory in the root CA archive will need to be replaced with the one in the <code>intermediate_authority</code> archive.  As the two archives are overlaid when both are present during unarchival, this can be accomplished by having both archives present, creating the container, and then running <code>archive_ca</code>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../distribution/" class="btn btn-neutral float-right" title="Root Certificate Distribution">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../details_and_setup/" class="btn btn-neutral" title="Operational Overview and Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/triplepoint/certificate-authority-guide/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../details_and_setup/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../distribution/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
